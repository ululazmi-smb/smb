var id_user = "";
let pelanggan = $("#pengguna").DataTable({
    responsive: true,
    scrollX: true,
    columnDefs: [{
        searcable: false,
        orderable: false,
        targets: 0
    }],
    order: [
        [1, "asc"]
    ]
});
$(document).ready(function(){
    start();
});
function start()
{
    $.ajax({
        url: getDataStart,
        type: "POST",
        dataType: "json",
        data: {
            bulan : $("#bulan_id").val(),
            tahun : $("#tahun_id").val()
        },
        success: res => {
            pelanggan.clear().draw();
            id_user = "";
            if(res.error == "success")
            {
                if(res.data.length < 1)
                {
                    Swal.fire("Notification", "tidak ada data tagihan pada bulan " + $("#bulan_id").val() + " tahun " + $("#tahun_id").val(), "info");
                }
                for(let i = 0; i < res.data.length; i++)
                {
                    var r = res.data[i];
                    
                    pelanggan.row.add(['',r.nomor_tagihan,r.nama,r.nama_paket,r.bulan_tahun,rupiah(r.tagihan),r.jatuh_tempo,r.status_bayar,r.action]).draw(false);
                }
            } else {
                Swal.fire("Galat", res.messages, "error");
            }
        },
        error: err => {
            id_user = "";
            console.log(err)
        }
    })
}

function rupiah(nominal)
{
    const numb = nominal;
    const format = numb.toString().split('').reverse().join('');
    const convert = format.match(/\d{1,3}/g);
    const rupiah = 'Rp ' + convert.join('.').split('').reverse().join('');
    return rupiah;
}

function generate()
{
    $.ajax({
        url: urlGenerate,
        type: "POST",
        dataType: "json",
        data: {
            bulan : $("#bulan_id").val(),
            tahun : $("#tahun_id").val()
        },
        success: res => {
            if(res.error == "success")
            {
                start();
                Swal.fire("Success", res.messages, "success");
            } else {
                Swal.fire("Galat", res.messages, "error");
            }
        },
        error: err => {
            id_user = "";
            console.log(err)
        }
    })
}

function remove(id)
{
    Swal.fire({
        title: "Hapus",
        text: "Hapus tagihan ini?",
        type: "warning",
        showCancelButton: true
    }).then(() => {
        // $.ajax({
        //     url: deleteUrl,
        //     type: "post",
        //     dataType: "json",
        //     data: {
        //         id: id
        //     },
        //     success: () => {
        //         Swal.fire("Sukses", "Sukses Menghapus Data", "success");
        //         reloadTable();
        //     },
        //     error: () => {
        //         console.log(a);
        //     }
        // })
    })
}

function bayar(id)
{
    Swal.fire({
        title: "Bayar Tagihan",
        text: "Apakah tagihan ini sudah di lunasi?",
        type: "warning",
        showCancelButton: true
    }).then(() => {
        // $.ajax({
        //     url: deleteUrl,
        //     type: "post",
        //     dataType: "json",
        //     data: {
        //         id: id
        //     },
        //     success: () => {
        //         Swal.fire("Sukses", "Sukses Menghapus Data", "success");
        //         reloadTable();
        //     },
        //     error: () => {
        //         console.log(a);
        //     }
        // })
    })
}

$("#nama_user").select2({
    placeholder: "Nama User",
    ajax: {
        url: getUrlNama,
        type: "post",
        dataType: "json",
        data: params => ({
            barcode: params.term
        }),
        processResults: res => ({
            results: res
        }),
        cache: true
    }
});

function reloadTable() {
    pelanggan.ajax.reload()
}
pelanggan.on("order.dt search.dt", () => {
    pelanggan.column(0, {
        search: "applied",
        order: "applied"
    }).nodes().each((el, val) => {
        el.innerHTML = val + 1
    })
});