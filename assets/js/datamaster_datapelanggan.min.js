var status_fungsi = "";
var id_user_get = "";
let url, pelanggan = $("#paket").DataTable({
    responsive: true,
    scrollX: true,
    ajax: readUrl,
    columnDefs: [{
        searcable: false,
        orderable: false,
        targets: 0
    }],
    order: [
        [1, "asc"]
    ],
    columns: [{
        data: null
    }, {
        data: "nomor_tagihan"
    }, {
        data: "nama"
    }, {
        data: "alamat"
    }, {
        data: "no_tlp"
    }, {
        data: "paket"
    }, {
        data: "harga",render: $.fn.dataTable.render.number( '.', '.', 0, 'Rp' )
    }, {
        data: "tanggal_pemasangan"
    }, {
        data: "jatuh_tempo"
    }, {
        data: "pppoe"
    }, {
        data: "ip"
    }, {
        data: "status"
    }, {
        data: "action"
    }]
});

function load_paket(id_paket = null, id_status = null)
{
    $('#ip_address').mask('0ZZ.0ZZ.0ZZ.0ZZ', { translation: { 'Z': { pattern: /[0-9]/, optional: true } } });
    $.ajax({
        url: readUrlpaket,
        type: "POST",
        dataType: "json",
        data: {},
        success: res => {
            var list_paket = document.getElementById("list_paket");
            var status_user = document.getElementById("status_user");
            list_paket.innerHTML = "";
            status_user.innerHTML = "";
            var opt = "";
            for(let i = 0; i < res.data.length; i++)
            {
                if(res.data[i].id == id_paket)
                {
                    opt = opt + "<option value='"+ res.data[i].id +"' selected> " + res.data[i].paket + " " + res.data[i].harga +" </option>";
                } else {
                    opt = opt + "<option value='"+ res.data[i].id +"'> " + res.data[i].paket + " " + res.data[i].harga +" </option>";
                }
            }
            if(id_status == "active")
            {
                status_user.innerHTML = "<option value='active' selected>active</option><option value='suspen'>suspen</option>";
            } else if(id_status == "active")
            {
                status_user.innerHTML = "<option value='active'>active</option><option value='suspen' selected>suspen</option>";
            } else {
                status_user.innerHTML = "<option value='active'>active</option><option value='suspen'>suspen</option>";
            }
            list_paket.innerHTML = opt;
        },
        error: err => {
            console.log(err)
        }
    });
}

function initial()
{
    $("#email").removeAttr("disabled");
    $("#username").removeAttr("disabled");
    $("#password").removeAttr("disabled");
    $("#email").val("");
    $("#username").val("");
    $("#nama_pelanggan").val("");
    $("#alamat").val("");
    $("#nomor_telepon").val("");
    $("#id_telegram").val("");
    $("#tanggal_pemasangan").val("");
    $("#jatuh_tempo").val("");
    $("#akun_pppoe").val("");
    $("#ip_address").val("");
}

function add()
{
    id_user = "";
    initial();
    document.getElementById("title_modal").innerHTML = "Tambah User";
    status_fungsi = "add";
    load_paket();
}

function edit(id_user)
{
    initial();
    document.getElementById("title_modal").innerHTML = "Edit User";
    $("#email").attr("disabled", true);
    $("#username").attr("disabled", true);
    $("#password").attr("disabled", true);
    status_fungsi = "edit";
    $.ajax({
        url: getUrlUser,
        type: "POST",
        dataType: "json",
        data: {
            id_user: id_user
        },
        success: res => {
            $("#email").val(res.data.email);
            $("#username").val(res.data.username);
            $("#nama_pelanggan").val(res.data.nama_pelanggan);
            $("#alamat").val(res.data.alamat);
            $("#nomor_telepon").val(res.data.no_telp);
            $("#id_telegram").val(res.data.id_telegram);
            load_paket(res.data.id_paket, res.data.status);
            $("#tanggal_pemasangan").val(res.data.tanggal_pemasangan);
            $("#jatuh_tempo").val(res.data.jatuh_tempo);
            $("#akun_pppoe").val(res.data.akun_pppoe);
            $("#ip_address").val(res.data.ip_address);
            id_user_get = id_user;
        },
        error: err => {
            console.log(err)
        }
    });
}

function save()
{
    var data = {
        email : $("#email").val(),
        password : $("#password").val(),
        username : $("#username").val(),
        nama_pelanggan : $("#nama_pelanggan").val() ,
        alamat : $("#alamat").val(),
        no_tlp : $("#nomor_telepon").val(),
        id_telegram : $("#id_telegram").val(),
        tanggal_pemasangan : $("#tanggal_pemasangan").val(),
        jatuh_tempo : $("#jatuh_tempo").val() ,
        akun_pppoe : $("#akun_pppoe").val(),
        ip_address : $("#ip_address").val(),
        list_paket : $("#list_paket").val(),
        status_user : $("#status_user").val(),
        id_user: id_user_get,
        status_f : status_fungsi
    }
    $.ajax({
        url: addUrlUser,
        type: "POST",
        dataType: "json",
        data: data,
        success: res => {
            if(res.error == "success")
            {
                Swal.fire("Success", res.messages, "success");
                $(".modal").modal("hide");
                reloadTable();
            } else {
                Swal.fire("Galat", res.messages, "error");
            }
        },
        error: err => {
            console.log(err)
        }
    });
}

function reloadTable() {
    pelanggan.ajax.reload()
}
pelanggan.on("order.dt search.dt", () => {
    pelanggan.column(0, {
        search: "applied",
        order: "applied"
    }).nodes().each((el, val) => {
        el.innerHTML = val + 1
    })
});